<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - DBcolor</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .admin-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .admin-stat-card {
        background: var(--bg-card);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }

      .admin-stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent-green);
        margin-bottom: 5px;
      }

      .admin-stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .users-table {
        background: var(--bg-card);
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }

      .users-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .users-table th,
      .users-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .users-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-primary);
      }

      .users-table tr:hover {
        background: var(--bg-hover);
      }

      .admin-actions {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .btn-admin {
        background: var(--accent-green);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }

      .btn-admin:hover {
        background: #00cc88;
      }

      .btn-admin.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .btn-admin.secondary:hover {
        background: var(--bg-hover);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .error {
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      @media (max-width: 768px) {
        .users-table {
          overflow-x: auto;
        }

        .users-table table {
          min-width: 600px;
        }

        .admin-actions {
          flex-direction: column;
        }

        .btn-admin {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>üéØ Painel Administrativo - DBcolor</h1>
        <p>Gerencie usu√°rios e visualize estat√≠sticas do sistema</p>
      </div>

      <div id="errorMessage" class="error" style="display: none"></div>

      <div class="admin-actions">
        <button id="btnRefreshStats" class="btn-admin">
          Atualizar Estat√≠sticas
        </button>
        <button id="btnRefreshUsers" class="btn-admin secondary">
          Atualizar Usu√°rios
        </button>
        <button id="btnResetState" class="btn-admin" style="background:#ff6b6b">Resetar Estado</button>
        <button id="btnBackToApp" class="btn-admin secondary">
          Voltar ao App
        </button>
      </div>

      <div class="admin-stats" id="statsContainer">
        <div class="loading">Carregando estat√≠sticas...</div>
      </div>

      <div class="users-table">
        <h3 style="padding: 15px; margin: 0; color: var(--text-primary);">üë• Usu√°rios</h3>
        <table id="usersTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Username</th>
              <th>Bankroll</th>
              <th>Cores Habilitadas</th>
              <th>Padr√µes</th>
              <th>Alertas</th>
              <th>Admin</th>
              <th>Data Cadastro</th>
              <th>√öltimo Login</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="9" class="loading">Carregando usu√°rios...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Logs de Atividade -->
      <div class="users-table" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px;">
          <h3 style="margin: 0; color: var(--text-primary);">üìã Logs de Atividade</h3>
          <select id="logActionFilter" style="padding: 8px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
            <option value="">Todas as a√ß√µes</option>
            <option value="login">Login</option>
            <option value="login_failed">Login Falhou</option>
            <option value="logout">Logout</option>
            <option value="page_access">Acesso</option>
            <option value="admin_action">A√ß√£o Admin</option>
          </select>
        </div>
        <table id="logsTable">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Email</th>
              <th>A√ß√£o</th>
              <th>Detalhes</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody id="logsTableBody">
            <tr>
              <td colspan="5" class="loading">Carregando logs...</td>
            </tr>
          </tbody>
        </table>
        <div style="display: flex; justify-content: center; gap: 10px; padding: 15px;">
          <button id="logsPrevPage" class="btn-admin secondary">‚Üê Anterior</button>
          <span id="logsPageInfo" style="padding: 10px; color: var(--text-secondary);">1 de 1</span>
          <button id="logsNextPage" class="btn-admin secondary">Pr√≥xima ‚Üí</button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:3001"
          : "";

      // Check if user is admin
      async function checkAdminAccess() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            window.location.href = "/auth";
            return;
          }

          const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error("N√£o autorizado");
          }

          const user = await response.json();
          if (!user.is_admin) {
            showError(
              "Acesso negado - apenas administradores podem acessar esta p√°gina"
            );
            setTimeout(() => (window.location.href = "/"), 3000);
            return;
          }

          // Load data
          loadStats();
          loadUsers();
        } catch (error) {
          console.error("Erro ao verificar acesso:", error);
          window.location.href = "/auth";
        }
      }

      async function loadStats() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`${API_BASE_URL}/api/auth/admin/stats`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Erro ao carregar estat√≠sticas");

          const data = await response.json();
          displayStats(data);
        } catch (error) {
          console.error("Erro ao carregar estat√≠sticas:", error);
          showError("Erro ao carregar estat√≠sticas");
        }
      }

      async function loadUsers() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`${API_BASE_URL}/api/auth/admin/users`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Erro ao carregar usu√°rios");

          const data = await response.json();
          displayUsers(data.users);
        } catch (error) {
          console.error("Erro ao carregar usu√°rios:", error);
          showError("Erro ao carregar usu√°rios");
        }
      }

      function displayStats(stats) {
        const container = document.getElementById("statsContainer");
        container.innerHTML = `
          <div class="admin-stat-card">
            <div class="admin-stat-value">${stats.total_users}</div>
            <div class="admin-stat-label">Total de Usu√°rios</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-value">${stats.active_users_24h || 0}</div>
            <div class="admin-stat-label">Ativos (24h)</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-value">R$ ${stats.total_bankroll.toFixed(2)}</div>
            <div class="admin-stat-label">Bankroll Total</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-value">${stats.total_signals_30d || 0}</div>
            <div class="admin-stat-label">Sinais (30 dias)</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-value" style="color: ${(stats.signal_rate_30d || 0) >= 50 ? 'var(--accent-green)' : '#ff6b6b'}">${stats.signal_rate_30d || 0}%</div>
            <div class="admin-stat-label">Taxa de Acerto</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-value">${stats.total_logs || 0}</div>
            <div class="admin-stat-label">Total de Logs</div>
          </div>
        `;
      }

      function displayUsers(users) {
        const tbody = document.getElementById("usersTableBody");

        if (users.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align: center;">Nenhum usu√°rio encontrado</td></tr>';
          return;
        }

        tbody.innerHTML = users
          .map(
            (user) => `
          <tr>
            <td>${user.email}</td>
            <td>${user.username || "-"}</td>
            <td>R$ ${parseFloat(user.bankroll || 0).toFixed(2)}</td>
            <td>${(user.enabled_colors || []).join(", ")}</td>
            <td>${
              (user.enabled_patterns || []).length > 0
                ? user.enabled_patterns.join(", ")
                : "Todos"
            }</td>
            <td>${user.receive_alerts ? "Sim" : "N√£o"}</td>
            <td>${user.is_admin ? "Sim" : "N√£o"}</td>
            <td>${
              user.created_at
                ? new Date(
                    user.created_at.$date || user.created_at
                  ).toLocaleDateString("pt-BR")
                : "-"
            }</td>
            <td>${
              user.last_login
                ? new Date(user.last_login).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" })
                : "-"
            }</td>
          </tr>
        `
          )
          .join("");
      }

      // Logs de Atividade
      let logsPage = 1;
      let logsTotalPages = 1;
      
      async function loadLogs() {
        try {
          const token = localStorage.getItem("token");
          const actionFilter = document.getElementById("logActionFilter").value;
          const url = `${API_BASE_URL}/api/auth/admin/logs?page=${logsPage}&limit=20${actionFilter ? '&action=' + actionFilter : ''}`;
          
          const response = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();
          if (data.ok) {
            logsTotalPages = data.totalPages || 1;
            displayLogs(data.data);
            document.getElementById("logsPageInfo").textContent = `${logsPage} de ${logsTotalPages}`;
            document.getElementById("logsPrevPage").disabled = logsPage <= 1;
            document.getElementById("logsNextPage").disabled = logsPage >= logsTotalPages;
          } else {
            throw new Error(data.error || "Erro ao carregar logs");
          }
        } catch (error) {
          console.error("Erro ao carregar logs:", error);
          document.getElementById("logsTableBody").innerHTML = 
            '<tr><td colspan="5" style="text-align: center;">Erro ao carregar logs</td></tr>';
        }
      }
      
      function displayLogs(logs) {
        const tbody = document.getElementById("logsTableBody");
        
        if (logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum log encontrado</td></tr>';
          return;
        }
        
        const actionColors = {
          "login": "#00ff88",
          "login_failed": "#ff6b6b",
          "logout": "#ff9800",
          "page_access": "#667eea",
          "admin_action": "#9c27b0"
        };
        
        tbody.innerHTML = logs.map(log => `
          <tr>
            <td>${log.datetime ? new Date(log.datetime).toLocaleString("pt-BR") : "-"}</td>
            <td>${log.email || "-"}</td>
            <td><span style="color: ${actionColors[log.action] || '#e0e4f0'}">${log.action}</span></td>
            <td>${log.details || "-"}</td>
            <td>${log.ip || "-"}</td>
          </tr>
        `).join("");
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => (errorDiv.style.display = "none"), 5000);
      }

      // Event listeners
      document
        .getElementById("btnRefreshStats")
        .addEventListener("click", loadStats);
      document
        .getElementById("btnRefreshUsers")
        .addEventListener("click", loadUsers);
      document.getElementById("btnBackToApp").addEventListener("click", () => {
        window.location.href = "/";
      });

      document.getElementById("btnResetState").addEventListener("click", async () => {
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(`${API_BASE_URL}/api/admin/reset`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (res.ok && data.ok) {
            showError("Estado do servidor resetado com sucesso.");
            await loadStats();
          } else {
            showError(data.error || "Falha ao resetar estado");
          }
        } catch (e) {
          showError("Erro de conex√£o ao resetar estado");
        }
      });
      
      // Logs pagination
      document.getElementById("logsPrevPage").addEventListener("click", () => {
        if (logsPage > 1) {
          logsPage--;
          loadLogs();
        }
      });
      
      document.getElementById("logsNextPage").addEventListener("click", () => {
        if (logsPage < logsTotalPages) {
          logsPage++;
          loadLogs();
        }
      });
      
      document.getElementById("logActionFilter").addEventListener("change", () => {
        logsPage = 1;
        loadLogs();
      });

      // Initialize
      async function initAdmin() {
        await checkAdminAccess();
        loadLogs();
      }
      
      initAdmin();
    </script>
  </body>
</html>
